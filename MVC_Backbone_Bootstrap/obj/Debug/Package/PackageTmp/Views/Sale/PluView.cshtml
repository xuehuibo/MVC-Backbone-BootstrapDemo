<script type="text/template" id="tempPluList">
    @*商品列表模板*@
    
    <%for(var i=10*(curPage-1);i<10*(curPage-1)+10 && i<pluList.length;i++){%>
   <div class="list-group-item media">
        <div class="list-group-item-body row">
            <img class="media-object col-xs-3" src="../Content/images/<%=pluList[i].PluImage%>.jpg">
            <div class="col-xs-8 col-xs-offset-1">
                <h4 class="media-heading"><%=pluList[i].PluCode+'--'+pluList[i].PluName%></h4>
                <h4>条码：<%=pluList[i].BarCode%></h4>
                <div class="row">
                    <div class="col-xs-5">
                        <h4>原价：<span class="label label-default">￥<%=pluList[i].Price%></span></h4>
                        <h4>现价：<span class="label label-primary">￥<%=pluList[i].FsPrice==undefined?pluList[i].Price:pluList[i].FsPrice%></span></h4>
                        <h4>折扣：<span class="label label-warning"><%=pluList[i].Dsc==undefined?100:pluList[i].FsPrice%>%</span></h4>
                    </div>
                    <div class="col-xs-5">
                        <h4>单位：<%=pluList[i].Unit%></h4>
                        <h4>规格：<%=pluList[i].Spec%></h4>
                    </div>
                    <div class="btn-group pull-right">
                        <a class="btn btn-primary" href="#sale/<%=i%>">购买</a>
                    </div>
                </div>
                <div class="row">
                    <p><b><%=pluList[i].Brief%></b></p>
                </div>
            </div>
        </div>
    </div>
    <% }%>
    <div>
        <center>
             <ul class="pagination">
                 <%if(curPage==1){%>
                <li class="disabled"><a>&laquo;</a></li>
                 <%}else {%>
                 <li><a href="#goToPage/<%=parseInt(curPage)-1%>">&laquo;</a></li>
                 <%}%>
                 <% var firstPage=curPage-4 ;%>
                 <% if(firstPage>maxPage-9){%>
                 <%     firstPage=maxPage-9; %>
                 <%}%>
                 <% if(firstPage<=0){ %>
                 <%     firstPage=1;%>
                 <% }%>
                 <% for(var i=firstPage;i<=curPage+5 && i<=maxPage;i++){ %>
                    <% if(i==curPage){%>
                   <li class="active"><a><%=i%></a></li>
                    <% }else {%>
                   <li><a href="#goToPage/<%=i%>"><%=i%></a></li>
                    <% }%>
                 <%}%>
                 <%if(10*curPage>pluList.length){%>
                <li class="disabled"><a>&raquo;</a></li>
                 <%} else {%>
                  <li><a href="#goToPage/<%=parseInt(curPage)+1%>">&raquo;</a></li>
                 <%}%>
            </ul>
        </center>
    </div>
</script>

<script type="text/javascript">
    var router; //行为路由
    var pluView;
    var pluList; //商品列表
    var salePluList; //商品销售列表
    var filterView;//过滤器

    //#region 声明命名空间
    if (window.Plu == undefined) {
        Tools.Namespace.register("window.Plu");
    }
    //#endregion

    //#region 声明类型

    //#region 声明PluModel
    if (window.Plu.PluModel == undefined) {
        window.Plu.PluModel = Backbone.Model.extend({
            defaults: {
                "OrgCode": "",
                "DepId": "",
                "DepCode": "",
                "ShpId": "",
                "ShpCode": "",
                "PluId": "",
                "PluCode": "",
                "PluName": "",
                "ExPluCode": "",
                "BarCode": "",
                "Unit": "",
                "Spec": "",
                "Price": 0,
                "HyPrice": 0
            }
        });
    }
    //#endregion

    //#region   声明PluList
    if (window.Plu.PluList == undefined) {
        window.Plu.PluList = Backbone.Collection.extend({
            url: "../api/PluApi",
            model: window.Plu.PluModel
        });
    }
    //#endregion

    //#region 声明PluView
    if (window.Plu.PluView == undefined) {
        window.Plu.PluView = Backbone.View.extend({
            tagName: "div",
            className: "panel panel-info col-xs-9",
            $typeFilter: null,//类型过滤器
            $infoFilter: null,//信息过滤器
            maxPage: 1,
            curPage:1,
            iniatialize: function () {
                this.$typeFilter = $("#$typeFilter");
                this.$infoFilter = $("#$infoFilter");
            },
            template: _.template($("#tempPluList").html()),
            render: function () {
                this.$el.html(this.template({ pluList: pluList.toJSON(pluList), maxPage: this.maxPage, curPage: this.curPage }));
                location.hash = "do";
            },
            events: {
                "click #btnFilter": "doPluFilter"
            },
            doPluFilter: function(){
                router.navigate("pluFilter", { trigger: true });
            }
        });
    }
    //#endregion

    //#region   声明FilterView
    if (window.Plu.FilterView == undefined) {
        window.Plu.FilterView = Backbone.View.extend({
            filterValue: "",
            filterType:0,
            events: {
                "click label":"clickType"
            },
            clickType: function (e) {
                var type = $(e.currentTarget).children("input").val();
                router.navigate("filter/"+type, { trigger: true});
            },
            doFilter: function (filterType) {
                if (filterType == 0) {
                    $("#filterValue").val("");
                }
                this.filterType = filterType;
                this.filterValue = $("#filterValue").val();
                router.navigate("getPluList", { trigger: true });
            }
        });
    }
    //#endregion

    //#region 声明router
    if (window.Plu.Router == undefined) {
        window.Plu.Router = Backbone.Router.extend({
            routes: {
                "getPluList": "doGetPluList",
                "sale/:index": "doSale",
                "filter/:type": "setFilter",
                "goToPage/:page":"goToPage"
            },
            doGetPluList: function () {
                pluList.fetch({
                    data: {
                        filterType: filterView.filterType,
                        filterValue: filterView.filterValue
                    },
                    success: function (collection, response, options) {
                        //获取商品成功
                        pluView.maxPage = response.length/10+1;
                        pluView.curPage = 1;
                        pluView.render();
                    },
                    error: function (collection, response, options) {
                        //获取商品失败
                        alert("获取商品信息失败！");
                    }
                });
            },

            doSale: function (index) {
                console.info("sale" + index);
            },

            setFilter: function (type) {
                console.info("filter");
                switch (type) {
                    case "0":
                        //全部商品
                        filterView.doFilter(0);
                        break;
                    case "1":
                        //过滤商品
                        filterView.doFilter(1);
                        break;
                }
            },

            goToPage: function (page) {
                //console.info(page);
                pluView.curPage = page;
                pluView.render();
            }
        });
    }
//#endregion

    //#region   初始化对象
        $(function () {
            pluList = new window.Plu.PluList(); //商品列表
        
            pluView = new window.Plu.PluView({
                el: "#pluView"
            });
            filterView = new window.Plu.FilterView({
                el: "#pluFilter"
            })
            //var salePluList; //商品销售列表
            router = new window.Plu.Router(); //行为路由
    //        Backbone.history.start();//开启路由
            router.navigate("getPluList", { trigger: true });
        });
        //#endregion

</script>
<div class="navbar" id="pluFilter">
    <div class="navbar-form navbar-left">
        <div class="form-group">
            <input id="filterValue" type="text" class="form-control" placeholder="条码、编码或品名"/>
        </div>
        <div class="btn-group" data-toggle="buttons">
                <label class="btn btn-default active">
                    <input type="radio" value="0"/>全部商品
                </label>
                <label class="btn btn-default">
                    <input type="radio" value="1"/>过滤商品
                </label>
        </div>

    </div>   
</div>

<div id="pluView" class="media-list">
            
</div>